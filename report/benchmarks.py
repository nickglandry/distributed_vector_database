import re
import pandas as pd
import matplotlib.pyplot as plt

# Results from benchmarking tests - 10 trials after 3 warm-up trials. Dimensions = 768
e768_s1 = [27.058243989944458, 26.596535205841064, 26.661199808120728, 26.738465070724487, 26.7200870513916, 26.75694179534912, 26.841043949127197, 26.887968063354492, 26.818860054016113, 26.558367013931274, 26.372254848480225]
e768_s2 = [20.173192977905273, 20.086318016052246, 20.07922101020813, 20.070739030838013, 20.08366584777832, 20.046562910079956, 20.047702074050903, 19.97377109527588, 20.06469988822937, 20.01541805267334, 20.03995394706726]
e768_s4 = [10.399278163909912, 10.383584976196289, 10.346181154251099, 10.266906976699829, 11.94399905204773, 10.77599573135376, 10.401671886444092, 10.518860101699829, 10.544514179229736, 10.156854152679443, 9.976825952529907]
e768_s8 = [4.219841957092285, 4.230017900466919, 4.253957986831665, 4.3331170082092285, 4.234124660491943, 4.252100944519043, 4.187302827835083, 4.28526496887207, 4.283233165740967, 4.233993053436279, 4.2321860790252686]
e768_s16 = [2.2015249729156494, 2.1561226844787598, 2.13061785697937, 2.1792759895324707, 2.1588258743286133, 2.1274380683898926, 2.174118995666504, 2.1597580909729004, 2.1207196712493896, 2.1391420364379883, 2.1484739780426025]
e768_s32 = [1.1461129188537598, 1.1210308074951172, 1.130504846572876, 1.1086702346801758, 1.1059589385986328, 1.109450101852417, 1.1160240173339844, 1.1335439682006836, 1.1210949420928955, 1.089766025543213, 1.093027114868164]
e768_s64 = [0.7732491493225098, 0.7228639125823975, 0.7826499938964844, 0.7465527057647705, 0.7771482467651367, 0.7254180908203125, 0.7593138217926025, 0.7652900218963623, 0.7207469940185547, 0.7669298648834229, 0.781714916229248]
e768_s128 = [0.35748934745788574, 0.40663599967956543, 0.3547961711883545, 0.3500940799713135, 0.3625500202178955, 0.3582448959350586, 0.39945006370544434, 0.3784677982330322, 0.36449313163757324, 0.35746216773986816, 0.40230298042297363]
e768_s256 = [0.3404092788696289, 0.3250579833984375, 0.3450968265533447, 0.3762519359588623, 0.3202500343322754, 0.33644795417785645, 0.3229372501373291, 0.3270430564880371, 0.3744518756866455, 0.3244340419769287, 0.3351469039916992]

e384_s1 = [21.01395583152771, 21.052796125411987, 21.20664119720459, 21.1463520526886, 21.19683599472046, 21.091660022735596, 21.246595859527588, 21.154001235961914, 21.17802381515503, 21.304852962493896, 21.20374298095703]
e384_s2 = [15.869599103927612, 15.938225269317627, 15.877980947494507, 15.931144952774048, 15.886899948120117, 15.892401933670044, 15.876362800598145, 16.278654098510742, 15.733542203903198, 15.252486944198608, 15.330706119537354]
e384_s4 = [3.8345179557800293, 3.8487889766693115, 3.83117413520813, 3.8472719192504883, 3.836413860321045, 3.8262441158294678, 3.846752882003784, 3.8195459842681885, 3.83797287940979, 3.8277671337127686, 3.8181729316711426]
e384_s8 = [3.059424877166748, 3.0716209411621094, 3.083510160446167, 3.0929319858551025, 3.069807767868042, 3.0065321922302246, 3.0412538051605225, 3.023106098175049, 3.065934181213379, 3.073091745376587, 3.0700552463531494]
e384_s16 = [1.665137767791748, 1.661776065826416, 1.6816058158874512, 1.6630980968475342, 1.6960251331329346, 1.683168888092041, 1.6562728881835938, 1.6649751663208008, 1.6816542148590088, 1.6874229907989502, 1.6537537574768066]
e384_s32 = [0.7605228424072266, 0.7890291213989258, 0.7857089042663574, 0.7564988136291504, 0.7903501987457275, 0.7929940223693848, 0.7842926979064941, 0.7620961666107178, 0.7826550006866455, 0.7857859134674072, 0.7636852264404297]
e384_s64 = [0.5586721897125244, 0.536768913269043, 0.5545628070831299, 0.5428800582885742, 0.5625331401824951, 0.5322840213775635, 0.5577998161315918, 0.5360310077667236, 0.5602471828460693, 0.5317330360412598, 0.5715959072113037]
e384_s128 = [0.3175697326660156, 0.2861521244049072, 0.2834742069244385, 0.3062632083892822, 0.2820920944213867, 0.28358912467956543, 0.28278684616088867, 0.3128821849822998, 0.28827595710754395, 0.28130316734313965, 0.2821481227874756]
e384_s256 = [0.14327096939086914, 0.12556695938110352, 0.1315019130706787, 0.1308600902557373, 0.15642619132995605, 0.13314580917358398, 0.12177729606628418, 0.127485990524292, 0.12116575241088867, 0.12326812744140625, 0.12424921989440918]

def build_df():
    pattern = re.compile(r"e(?P<embed>\d+)_s(?P<shards>\d+)")
    rows = []
    for name, values in globals().items():
        if not isinstance(values, list):
            continue
        match = pattern.fullmatch(name)
        if not match:
            continue
        series = pd.Series(values)
        rows.append({
            "embedding": int(match["embed"]),
            "shards": int(match["shards"]),
            "mean": series.mean(),
            "std": series.std()
        })
    return pd.DataFrame(rows)

def plot_by_shards(df):
    df = df.sort_values(["shards", "embedding"])
    mean = df.pivot(index="shards", columns="embedding", values="mean")
    err = df.pivot(index="shards", columns="embedding", values="std")
    ax = mean.plot(kind="bar", yerr=err, figsize=(12, 6), capsize=4)
    ax.set_xlabel("Shards")
    ax.set_ylabel("Mean time (seconds)")
    # ax.set_yscale("log")
    ax.set_title("Mean query runtime performance by shards across embedding sizes")
    ax.legend(title="Embedding dims")
    # plt.tight_layout()
    plt.show()

def plot_by_embedding(df):
    df = df.sort_values(["embedding", "shards"])
    mean = df.pivot(index="embedding", columns="shards", values="mean")
    err = df.pivot(index="embedding", columns="shards", values="std")
    ax = mean.plot(kind="bar", yerr=err, figsize=(12, 6), capsize=4)
    ax.set_xlabel("Embedding size (dims)")
    ax.set_ylabel("Mean time (seconds, log scale)")
    ax.set_yscale("log")
    ax.set_title("Mean query runtime performance by shards across embedding sizes")
    ax.legend(title="Shards")
    # plt.tight_layout()
    plt.show()



df = build_df()
plot_by_shards(df)
# plot_by_embedding(df)